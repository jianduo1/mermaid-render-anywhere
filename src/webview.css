/**
 * Mermaid WebView Styles
 * 优化版本 - 模块化CSS，减少重复代码
 */

/* CSS变量定义 */
:root {
    --border-radius: 8px;
    --spacing-xs: 4px;
    --spacing-sm: 8px;
    --spacing-md: 12px;
    --spacing-lg: 16px;
    --spacing-xl: 24px;
    --transition-fast: 0.15s ease;
    --transition-normal: 0.3s ease;
    --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
    --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* 基础重置 */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* 主体样式 */
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--vscode-editor-background);
    color: var(--vscode-editor-foreground);
    overflow: hidden;
    height: 100vh;
    line-height: 1.5;
}

/* 布局容器 */
.container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    position: relative;
}

/* 头部区域 */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md) var(--spacing-lg);
    background: var(--vscode-panel-background);
    border-bottom: 1px solid var(--vscode-panel-border);
    flex-shrink: 0;
    min-height: 48px;
}

.title {
    font-size: 14px;
    font-weight: 600;
    color: var(--vscode-editor-foreground);
}

/* 控制按钮 */
.controls {
    display: flex;
    gap: var(--spacing-sm);
    align-items: center;
}

.control-btn {
    background: var(--vscode-button-background);
    color: var(--vscode-button-foreground);
    border: none;
    padding: var(--spacing-sm);
    border-radius: var(--spacing-xs);
    cursor: pointer;
    font-size: 12px;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
}

.control-btn:hover {
    background: var(--vscode-button-hoverBackground);
    transform: translateY(-1px);
}

.control-btn:active {
    transform: translateY(0);
}

.control-btn.danger {
    background: var(--vscode-errorForeground);
}

.control-btn.danger:hover {
    background: var(--vscode-errorForeground);
    opacity: 0.8;
}

/* 滚轮锁定按钮样式 */
.control-btn.locked {
    background: var(--vscode-button-secondaryBackground, #4a4a4a);
    color: var(--vscode-button-secondaryForeground, #ffffff);
}

.control-btn.locked:hover {
    background: var(--vscode-button-secondaryHoverBackground, #5a5a5a);
}

.control-btn.locked svg {
    stroke: #4a9eff; /* 蓝色表示锁定状态 */
}

/* 内容区域 */
.content {
    flex: 1;
    overflow: auto;
    padding: var(--spacing-lg);
    position: relative;
}

/* 图表卡片 */
.mermaid-card {
    background: var(--vscode-editor-background);
    border: 1px solid var(--vscode-panel-border);
    border-radius: var(--border-radius);
    margin-bottom: var(--spacing-lg);
    overflow: hidden;
    box-shadow: var(--shadow-light);
    transition: all var(--transition-normal);
}

.mermaid-card:hover {
    box-shadow: var(--shadow-medium);
    border-color: var(--vscode-focusBorder);
}

.mermaid-card.collapsed {
    margin-bottom: var(--spacing-sm);
}

/* 卡片头部 */
.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md) var(--spacing-lg);
    background: var(--vscode-panel-background);
    border-bottom: 1px solid var(--vscode-panel-border);
    cursor: pointer;
    transition: background-color var(--transition-fast);
}

.card-header:hover {
    background: var(--vscode-list-hoverBackground);
}

.card-header.collapsed {
    border-bottom: none;
}

.card-title {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    flex: 1;
    min-width: 0; /* 允许flexbox子元素收缩 */
    overflow: hidden; /* 隐藏溢出内容 */
}

.collapse-indicator {
    font-size: 12px;
    transition: transform var(--transition-fast);
    color: var(--vscode-icon-foreground);
}

.chart-title-text {
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap; /* 防止文本换行 */
    overflow: hidden; /* 隐藏溢出文本 */
    text-overflow: ellipsis; /* 显示省略号 */
    flex: 1; /* 允许标题占用剩余空间 */
    min-width: 0; /* 允许收缩 */
}

.chart-title-with-function {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    flex: 1; /* 允许标题区域占用剩余空间 */
    min-width: 0; /* 允许收缩 */
    overflow: hidden; /* 隐藏溢出内容 */
}

.location-info {
    color: var(--vscode-textLink-foreground);
    cursor: pointer;
    font-size: 12px;
    padding: 2px var(--spacing-xs);
    border-radius: 3px;
    transition: background-color var(--transition-fast);
}

.location-info:hover {
    background: var(--vscode-textLink-activeForeground);
    color: var(--vscode-editor-background);
}

/* 卡片操作按钮 */
.card-actions {
    display: flex;
    gap: var(--spacing-xs);
    flex-shrink: 0; /* 防止按钮被压缩 */
    align-items: center;
}

.action-btn {
    background: transparent;
    border: none;
    padding: var(--spacing-xs);
    border-radius: 3px;
    cursor: pointer;
    color: var(--vscode-icon-foreground);
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
}

.action-btn:hover {
    background: var(--vscode-toolbar-hoverBackground);
    color: var(--vscode-icon-foreground);
}

/* 图表视口 */
.mermaid-viewport {
    position: relative;
    background: var(--vscode-editor-background);
    transition: all var(--transition-normal);
    overflow: hidden;
}

.mermaid-viewport.expanded {
    min-height: 200px;
    max-height: 800px;
}

.mermaid-viewport.collapsed {
    height: 0;
    min-height: 0;
    max-height: 0;
}

/* 图表容器 */
.mermaid-container {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: var(--spacing-lg);
    cursor: grab;
    overflow: hidden;
}

.mermaid-container:active {
    cursor: grabbing;
}

.mermaid-container svg {
    max-width: 100%;
    height: auto;
    transition: transform var(--transition-fast);
    border-radius: var(--spacing-xs);
}

/* 加载状态 */
.loading {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: var(--spacing-xl);
    color: var(--vscode-progressBar-background);
}

.spinner {
    width: 24px;
    height: 24px;
    border: 2px solid var(--vscode-panel-border);
    border-top: 2px solid var(--vscode-progressBar-background);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* 错误状态 */
.error-message, .error-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--spacing-xl);
    text-align: center;
    color: var(--vscode-errorForeground);
}

.error-icon {
    font-size: 32px;
    margin-bottom: var(--spacing-md);
}

.error-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: var(--spacing-sm);
}

.error-text {
    font-size: 13px;
    margin-bottom: var(--spacing-md);
    opacity: 0.8;
}

.retry-btn {
    background: var(--vscode-button-background);
    color: var(--vscode-button-foreground);
    border: none;
    padding: var(--spacing-sm) var(--spacing-lg);
    border-radius: var(--spacing-xs);
    cursor: pointer;
    font-size: 12px;
    transition: background-color var(--transition-fast);
}

.retry-btn:hover {
    background: var(--vscode-button-hoverBackground);
}

/* 空状态 */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--spacing-xl);
    text-align: center;
    color: var(--vscode-descriptionForeground);
}

.empty-state-icon {
    font-size: 48px;
    margin-bottom: var(--spacing-lg);
    opacity: 0.6;
}

.empty-state-text {
    font-size: 14px;
    line-height: 1.6;
}

/* 提示区域 */
.tip-section {
    margin-top: var(--spacing-xl);
    padding: var(--spacing-lg);
    background: var(--vscode-textBlockQuote-background);
    border: 1px solid var(--vscode-textBlockQuote-border);
    border-radius: var(--border-radius);
    font-size: 13px;
}

.tip-title {
    font-weight: 600;
    margin-bottom: var(--spacing-sm);
    color: var(--vscode-textPreformat-foreground);
}

.tip-content {
    line-height: 1.6;
    color: var(--vscode-descriptionForeground);
}

/* 预览弹窗 */
.preview-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    backdrop-filter: blur(2px);
}

.preview-modal {
    background: var(--vscode-editor-background);
    border: 1px solid var(--vscode-panel-border);
    border-radius: var(--border-radius);
    max-width: 90vw;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4);
    transition: all var(--transition-normal);
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md) var(--spacing-lg);
    background: var(--vscode-panel-background);
    border-bottom: 1px solid var(--vscode-panel-border);
    border-radius: var(--border-radius) var(--border-radius) 0 0;
    flex-shrink: 0;
}

.preview-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--vscode-editor-foreground);
    flex: 1;
    margin-right: var(--spacing-md);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.preview-controls {
    display: flex;
    gap: 2px;
    align-items: center;
    flex-shrink: 0;
}

.preview-btn, .preview-close {
    background: transparent;
    border: none;
    padding: var(--spacing-xs);
    border-radius: 4px;
    cursor: pointer;
    color: var(--vscode-icon-foreground);
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    position: relative;
}

.preview-btn:hover, .preview-close:hover {
    background: var(--vscode-toolbar-hoverBackground);
    transform: translateY(-1px);
}

.preview-btn:active, .preview-close:active {
    transform: translateY(0);
}

.preview-close {
    color: var(--vscode-errorForeground);
    margin-left: var(--spacing-xs);
}

.preview-close:hover {
    background: var(--vscode-errorForeground);
    color: var(--vscode-editor-background);
}

/* 预览控制按钮分组 */
.preview-controls .preview-btn:nth-child(1),
.preview-controls .preview-btn:nth-child(2) {
    /* 缩放控制组 */
    border-right: 1px solid var(--vscode-panel-border);
}

.preview-controls .preview-btn:nth-child(3),
.preview-controls .preview-btn:nth-child(4),
.preview-controls .preview-btn:nth-child(5) {
    /* 视图控制组 */
    margin-left: var(--spacing-xs);
}

.preview-controls .preview-btn:nth-child(6) {
    /* 全屏控制 */
    margin-left: var(--spacing-xs);
    border-left: 1px solid var(--vscode-panel-border);
    padding-left: var(--spacing-sm);
}

.preview-controls .preview-btn:nth-child(7) {
    /* 重置控制 */
    margin-left: 2px;
}

.preview-content {
    flex: 1;
    padding: 0;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 400px;
    background: var(--vscode-editor-background);
    position: relative;
    cursor: grab;
}

.preview-content:active {
    cursor: grabbing;
}

.preview-content svg {
    max-width: none;
    max-height: none;
    transition: transform 0.2s ease;
    user-select: none;
    pointer-events: none;
}

/* 预览信息提示 */
.preview-info {
    position: absolute;
    bottom: var(--spacing-md);
    left: var(--spacing-md);
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: 4px;
    font-size: 11px;
    font-family: monospace;
    pointer-events: none;
    opacity: 0;
    transition: opacity var(--transition-fast);
}

.preview-content:hover .preview-info {
    opacity: 1;
}

/* 全屏模式样式调整 */
.preview-modal.fullscreen {
    max-width: 100vw !important;
    max-height: 100vh !important;
    width: 100vw !important;
    height: 100vh !important;
    border-radius: 0 !important;
}

.preview-modal.fullscreen .preview-header {
    border-radius: 0;
}

/* 主题相关 */
.dark-theme {
    color-scheme: dark;
}

.light-theme {
    color-scheme: light;
}

/* 深色主题下的卡片主体优化 - 使用深灰色背景提供更好的对比度 */
.dark-theme .mermaid-card {
    background: #2d2d2d !important;
    border-color: #404040 !important;
}

.dark-theme .mermaid-container {
    background: #2d2d2d !important;
}

.dark-theme .mermaid-viewport {
    background: #2d2d2d !important;
}

/* 深色主题下的预览模态框 */
.dark-theme .preview-content {
    background: #2d2d2d !important;
}

.dark-theme .preview-modal {
    background: #2d2d2d !important;
    border-color: #404040 !important;
}

/* 深色主题下Mermaid图表的连线样式增强 */
.dark-theme .mermaid-viewport svg .edge-path path,
.dark-theme .mermaid-viewport svg .edge path,
.dark-theme .mermaid-viewport svg path.relation,
.dark-theme .mermaid-viewport svg .flowchart-link,
.dark-theme .mermaid-viewport svg .messageLine0,
.dark-theme .mermaid-viewport svg .messageLine1,
.dark-theme .mermaid-viewport svg line {
    stroke: #8cc8ff !important;
    stroke-width: 2px !important;
}

/* 深色主题下类图的连接线和箭头 */
.dark-theme .mermaid-viewport svg .relation,
.dark-theme .mermaid-viewport svg .relationshipLine,
.dark-theme .mermaid-viewport svg marker path {
    stroke: #8cc8ff !important;
    fill: #8cc8ff !important;
}

/* 深色主题下的文本标签背景 */
.dark-theme .mermaid-viewport svg .edgeLabel rect,
.dark-theme .mermaid-viewport svg .label rect {
    fill: #2d2d2d !important;
    stroke: #6bb6ff !important;
}

/* 深色主题下的文本颜色 */
.dark-theme .mermaid-viewport svg .edgeLabel text,
.dark-theme .mermaid-viewport svg .label text,
.dark-theme .mermaid-viewport svg text {
    fill: #ffffff !important;
}

/* 深色主题下类图节点边框 */
.dark-theme .mermaid-viewport svg .node rect,
.dark-theme .mermaid-viewport svg .classBox rect {
    stroke: #6bb6ff !important;
    stroke-width: 2px !important;
    fill: #3a3a3a !important;
}

/* 深色主题下确保所有路径元素都有足够的对比度 */
.dark-theme .mermaid-viewport svg path:not([fill]) {
    stroke: #8cc8ff !important;
    stroke-width: 2px !important;
}

/* 深色主题下的箭头标记 */
.dark-theme .mermaid-viewport svg defs marker polygon,
.dark-theme .mermaid-viewport svg defs marker path {
    fill: #8cc8ff !important;
    stroke: #8cc8ff !important;
}

/* 浅色主题下的卡片主体优化 - 使用纯白背景 */
.light-theme .mermaid-card {
    background: #ffffff !important;
    border-color: #e1e1e1 !important;
}

.light-theme .mermaid-container {
    background: #ffffff !important;
}

.light-theme .mermaid-viewport {
    background: #ffffff !important;
}

/* 浅色主题下的预览模态框 */
.light-theme .preview-content {
    background: #ffffff !important;
}

.light-theme .preview-modal {
    background: #ffffff !important;
    border-color: #e1e1e1 !important;
}

/* 响应式设计 */
@media (max-width: 768px) {
    .container {
        height: 100vh;
    }
    
    .header {
        padding: var(--spacing-sm) var(--spacing-md);
    }
    
    .content {
        padding: var(--spacing-md);
    }
    
    .card-header {
        padding: var(--spacing-sm) var(--spacing-md);
    }
    
    .mermaid-container {
        padding: var(--spacing-md);
    }
    
    .preview-modal {
        max-width: 95vw;
        max-height: 95vh;
        margin: var(--spacing-md);
    }
}

/* 滚动条样式 */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--vscode-scrollbarSlider-background);
}

::-webkit-scrollbar-thumb {
    background: var(--vscode-scrollbarSlider-background);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--vscode-scrollbarSlider-hoverBackground);
}

/* 选择文本样式 */
::selection {
    background: var(--vscode-editor-selectionBackground);
    color: var(--vscode-editor-selectionForeground);
}

/* 焦点样式 */
button:focus-visible,
.control-btn:focus-visible,
.action-btn:focus-visible {
    outline: 2px solid var(--vscode-focusBorder);
    outline-offset: 2px;
}

/* 打印样式 */
@media print {
    .header,
    .controls,
    .card-actions,
    .preview-overlay {
        display: none !important;
    }
    
    .mermaid-card {
        break-inside: avoid;
        box-shadow: none;
        border: 1px solid #ccc;
    }
    
    .mermaid-viewport.collapsed {
        height: auto !important;
        max-height: none !important;
    }
}